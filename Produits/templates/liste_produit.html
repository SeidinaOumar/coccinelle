{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Scan Produit - Coccinelle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'liste_produit.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      background-color: #fff;
      font-family: 'Segoe UI', sans-serif;
    }

    .scan-box {
      border: 2px dashed #c40018;
      border-radius: 16px;
      padding: 30px;
      position: relative;
      text-align: center;
      background: linear-gradient(to right, #fff, #fef1f1);
      box-shadow: 0 8px 16px rgba(220, 53, 69, 0.1);
    }

    .scan-box i {
      font-size: 40px;
      color: #c40018;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }

    #scanInput {
      border: 2px solid #c40018;
      border-radius: 10px;
      padding: 10px 15px;
      font-size: 1.2rem;
      margin-top: 15px;
    }

    .card-produit {
      animation: fadeIn 0.6s ease-in-out;
      margin-top: 20px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .img-produit {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-top-left-radius: 12px;
      border-bottom-left-radius: 12px;
    }

    .table thead {
      background-color: #c40018;
      color: white;
    }

    .btn-edit {
      background-color: #c40018;
      color: white;
      border-radius: 8px;
    }

    .btn-edit:hover {
      background-color: #c40018;
    }

    .btn-back {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
    }
  </style>
</head>
<body>

  <!-- Bouton Retour -->
  <a href="{% url 'produits' %}" class="btn btn-outline-danger btn-back">
    <i class="fas fa-arrow-left"></i>
  </a>

  <div class="container py-5">

    <!-- Box de Scan -->
    <div class="scan-box">
      <i class="fas fa-barcode"></i>
      <h4 class="mt-3 fw-bold">Rechercher par Scanner</h4>
      <input type="text" id="scanInput" class="form-control mt-3" placeholder="Scanner ici..." autofocus oninput="chercherProduit()" />
    </div>

    <!-- Résultat produit scanné -->
    <div id="resultatProduit" class="card card-produit d-none">
      <div class="row g-0">
        <div class="col-md-4">
          <img id="imgProduit" src="" alt="Image produit" class="img-produit h-100">
        </div>
        <div class="col-md-8 p-3">
          <h5 id="nomProduit" class="text-danger fw-bold"></h5>
          <p><strong>Référence :</strong> <span id="refProduit"></span></p>
          <p><strong>Prix :</strong> <span id="prixProduit"></span> FCFA</p>
          <p><strong>Stock :</strong> <span id="stockProduit"></span></p>
          <p><strong>Catégorie :</strong> <span id="catProduit"></span></p>
        </div>
      </div>
    </div>

    <!-- Liste Produits -->
    <h4 class="text-center mt-5 mb-4 text-danger">Liste des Produits</h4>
    <div class="table-responsive">
      <table class="table table-hover text-center align-middle">
        <thead>
          <tr>
            <th>Image</th>
            <th>Nom</th>
            <th>Référence</th>
            <th>Prix</th>
            <th>Stock</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="listeProduits">
          {% for produit in produits %}
          <tr>
            <td>
                {% if produit.image %}
                <img src="{{ produit.image.url }}" class="rounded" style="width: 60px; height: 60px; object-fit: cover;"></td>
                {% else %}
                <span>Pas d’image</span>
                {% endif %}
            <td>{{ produit.nom_produit }}</td>
            <td>{{ produit.reference }}</td>
            <td>{{ produit.prix_vente }} FCFA</td>
            <td>{{ produit.stock_actuel }}</td>
            <td>
              <a href="{% url 'edit_product' produit.pk %}" class="btn btn-edit">
                <i class="fas fa-pen-to-square"></i>
              </a>

              {% url 'delete_product' produit.pk as delete_url %}
                  <a href="#" class="btn btn-edit" onclick="openDeletePopup('{{ delete_url }}','{{ produit.pk }}','{{ produit.nom_produit }}')">
                  <i class="fa-solid fa-trash"></i>
                   </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  
</div>


 <script>
 function openDeletePopup(url,produitId, nomProduit) {
    const popup = document.getElementById('popup-confirm');
    const form = document.getElementById('popup-delete-form');
    const message = document.getElementById('popup-message');

    message.textContent = `Voulez-vous vraiment supprimer "${nomProduit}" ?`;
    form.action = url;

    popup.style.display = 'flex';
  }

  function closePopup() {
    document.getElementById('popup-confirm').style.display = 'none';
  } 
function chercherProduit() {
  const code = document.getElementById('scanInput').value;
  if (code.length >= 3) {
    fetch(`/produits/scan/produit/?code=${code}`)
      .then(response => response.json())
      .then(data => {
        console.log("JSON reçu :", data);

        const tbody = document.getElementById('listeProduits');
        tbody.innerHTML = ""; // Vider la liste avant de l'afficher

        if (data.found) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              ${data.image ? `<img src="${data.image}" class="rounded" style="width: 60px; height: 60px; object-fit: cover;">` : "Pas d'image"}
            </td>
            <td>${data.nom}</td>
            <td>${data.reference}</td>
            <td>${data.prix_vente} FCFA</td>
            <td>${data.stock_actuel}</td>
            <td>
              <a href="#" class="btn btn-edit">
                <i class="fas fa-pen-to-square"></i>
              </a>
               {% url 'edit_product' produit.pk as delete_url %}
                  <a href="#" class="btn btn-edit" onclick="openDeletePopup('{{ delete_url }}','{{ produit.pk }}','{{ produit.nom_produit }}')">
                  <i class="fa-solid fa-trash"></i>
                   </a>
            </td>
          `;
          tbody.appendChild(row);
        } else {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="6" class="text-center text-danger fw-bold">Produit introuvable</td>`;
          tbody.appendChild(row);
        }
      })
      .catch(error => {
        console.error("Erreur lors de la récupération du produit :", error);
      });
  }
}


</script>



</body>
<div id="popup-confirm" class="popup-confirmation">
  <div class="popup-box">
    <p id="popup-message">Confirmer la suppression ?</p>
    <form method="post" id="popup-delete-form">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">Oui</button>
      <button type="button" class="btn btn-secondary" onclick="closePopup()">Non</button>
    </form>
  </div>
</html>
