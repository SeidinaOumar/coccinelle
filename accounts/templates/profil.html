{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mon Profil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{% static 'profil.css' %}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body class="profil-body">
    <form id="photoForm" method="post" enctype="multipart/form-data" action="{% url 'changer_photo' %}">
  {% csrf_token %}
  <input type="file" id="photoUpload" class="d-none" name="photo" onchange="document.getElementById('photoForm').submit()">
</form>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10 profil-card shadow-lg p-4 rounded-4">
        <div class="row align-items-center">
          <!-- Section gauche : photo -->
          <div class="col-md-4 text-center position-relative">
            <div class="profil-image-container">
                {% if user.photo %}
              <img src="{{ user.photo.url }}" alt="Photo de profil" class="img-fluid rounded-circle profil-image">
              {% else %}
             <img src="{% static 'images/default-avatar.png' %}" alt="Photo de profil" class="img-fluid rounded-circle profil-image">
        {% endif %}

              <label for="photoUpload" class="btn btn-edit-icon">
                <i class="bi bi-pencil-fill"></i>
              </label>
              <input type="file" id="photoUpload" class="d-none" onchange="document.getElementById('photoForm').submit()">
            </div>
            <h3 class="mt-3">{{ user.first_name }} {{ user.last_name }}</h3>
            <p class="text-muted">{{ user.role }}</p>
          </div>

          <!-- Section droite : infos -->
          <div class="col-md-8">
            <h4 class="mb-3 text-white">Mes Informations</h4>
            <ul class="list-group list-group-flush mb-4">
              <li class="list-group-item"><strong>Email :</strong> {{ user.email }}</li>
              <li class="list-group-item"><strong>Téléphone :</strong> {{ user.contact }}</li>
              <li class="li   st-group-item"><strong>Adresse :</strong> {{ user.adresse }}</li>
              <li class="list-group-item"><strong>Dernière connexion :</strong> {{ user.last_login }}</li>
            </ul>

            <div class="d-flex flex-wrap gap-3">
                {% if request.user.role == 'admin' %}
<button  id="btnModifierInfos" type="button" class="btn btn-rouge" data-bs-toggle="modal" data-bs-target="#editInfosModal">
  <i class="bi bi-person-lines-fill me-1"></i> Modifier Infos
</button>
    {% endif %}          <a href="#" id="btnModifierMDP" class="btn btn-noir"><i class="bi bi-key me-1"></i> Mot de passe</a>
              <a href="#" class="btn btn-outline-light"><i class="bi bi-box-arrow-right me-1"></i> Déconnexion</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="editInfosModal" tabindex="-1" aria-labelledby="editInfosModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content text-white" style="background-color: #2a2a2a;">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="editInfosModalLabel">Modifier mes informations</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="editInfosForm" method="post">
        <div class="modal-body">
          {% csrf_token %}
          <div id="formContainer">
            {{ form.as_p }}
          </div>
          <div id="formErrors" class="text-danger mt-2"></div>
        </div>
        <div class="modal-footer border-0">
          <button type="submit" class="btn btn-danger">Enregistrer</button>
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Annuler</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="editPasswordModal" tabindex="-1" aria-labelledby="editPasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content text-white" style="background-color: #2a2a2a;">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="editPasswordModalLabel">Modifier mon mot de passe</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="formPasswordContainer"></div>
        <div id="formPasswordErrors" class="text-danger mt-2"></div>
      </div>
      <div class="modal-footer border-0">
        <button id="submitPasswordChange" type="button" class="btn btn-danger">Enregistrer</button>
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Annuler</button>
      </div>
    </div>
  </div>
</div>
<script>
    document.getElementById('btnModifierMDP').addEventListener('click', function () {
  fetch("{% url 'modifier_mot_de_passe' %}")
    .then(response => response.json())
    .then(data => {
      document.getElementById('formPasswordContainer').innerHTML = data.form_html;

      var modal = new bootstrap.Modal(document.getElementById('editPasswordModal'));
      modal.show();

      document.getElementById('submitPasswordChange').onclick = function() {
        const form = document.querySelector('#formPasswordContainer form');
        const formData = new FormData(form);

        fetch("{% url 'modifier_mot_de_passe' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            modal.hide();
            alert('Mot de passe modifié avec succès');
          } else {
            document.getElementById('formPasswordContainer').innerHTML = data.form_html;
          }
        });
      };
    });
});

</script>



<script>
const editInfosModalEl = document.getElementById('editInfosModal');
const editInfosModal = new bootstrap.Modal(editInfosModalEl);

document.getElementById('btnModifierInfos').addEventListener('click', function () {
  fetch("{% url 'modifier_infos' %}")
    .then(response => response.json())
    .then(data => {
      document.getElementById('formContainer').innerHTML = data.form_html;
      editInfosModal.show();

      // On récupère à nouveau le formulaire injecté
      const form = document.getElementById('editInfosForm');

      if (form) {
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          const formData = new FormData(this);

          fetch("{% url 'modifier_infos' %}", {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              editInfosModal.hide();
              location.reload();
            } else {
              document.getElementById('formContainer').innerHTML = data.form_html;
              // Réattacher l'écouteur sur le nouveau formulaire
              // Appel récursif ou mieux, une fonction pour ça
              // Pour simplifier, on peut appeler la fonction d'ajout d'écouteur ici
            }
          });
        }, { once: true });
      }
    });
});

// Nettoyage modal pour éviter overlay bloquant au cas où
editInfosModalEl.addEventListener('hidden.bs.modal', function () {
  const backdrops = document.getElementsByClassName('modal-backdrop');
  while (backdrops.length > 0) {
    backdrops[0].parentNode.removeChild(backdrops[0]);
  }
  document.body.classList.remove('modal-open');
});
</script>




</body>
</html>
