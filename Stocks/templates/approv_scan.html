<!-- approvisionnement.html -->
{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Approvisionnement | Coccinelle</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'approv_scan.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="bg-white text-dark">

  <div class="container mt-4 coccinelle-container">
    <a href="{% url 'approvisionnemment' %}" class="btn btn-outline-dark rounded-pill px-4">
      <i class="fas fa-truck-loading me-2"></i>  Sans Scanner
    </a>
    <!-- Barre de scan avec icÃ´ne -->
    <!-- Scan du code-barres -->
<div class="scan-box">
  <div class="scan-icon">   <i class="bi bi-upc-scan scan-icon "></i>
</div>
  <label for="barcodeInput" class="form-label fw-bold mt-2">Scanner le code-barres :</label>
  <input type="text" id="barcodeInput" placeholder="Scannez un produit..." autofocus>
</div>


    <!-- Infos produit -->
    <div id="produit-info" class="d-none card border-danger shadow-sm p-3 mb-4">
      <h5 class="text-danger">Produit trouvÃ© :</h5>
      <div class="d-flex align-items-center">
        <img id="produit-image" src="" alt="Image produit" class="me-3 rounded-circle border border-danger" width="80" height="80">
        <div>
          <p><strong>Nom :</strong> <span id="produit-nom"></span></p>
          <p><strong>RÃ©fÃ©rence :</strong> <span id="produit-ref"></span></p>
          <p><strong>Stock actuel :</strong> <span id="produit-stock"></span></p>
          <p><strong>Prix d'Achat :</strong><span id="product-price-buy"></span>  
            <strong> Prix de vente</strong><span id="product-price-sell"></span></p>
          <!-- <input type="hidden" id="produit-id" name="id_produit">-->
        </div>
      </div>
    </div>

    <!-- Formulaire dâ€™approvisionnement -->
    <form id="approvisionnement-form" method="post" class="bg-light border p-4 rounded shadow-sm">
      {% csrf_token %}

     {% if messages %}
  <div class="mt-2">
    {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

      
      {% if form.errors %}
  <div class="alert alert-danger">
    <ul>
      {% for field, errors in form.errors.items %}
        {% for error in errors %}
          <li><strong>{{ field }}:</strong> {{ error }}</li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
{% endif %}

      <input type="hidden" name="id_produit" id="form-produit-id">

      <div class="row g-3">
        <div class="col-md-4">
          <label for="quantite" class="form-label fw-semibold text-danger">QuantitÃ© :</label>
          <input type="number" id="quantite" name="quantite" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label for="prix_achat" class="form-label fw-semibold text-danger">Prix dâ€™achat :</label>
          <input type="number" id="prix_achat" name="prix_achat" step="0.01" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label for="prix_vente" class="form-label fw-semibold text-danger">Prix de vente :</label>
          <input type="number" id="prix_vente" name="prix_vente" step="0.01" class="form-control" required>
          
        </div>
      </div>

      <div class="mt-3">
         <label for="id_date_expiration" class="form-label fw-semibold text-danger">Date dâ€™expiration</label>
         {{ form.date_expiration }}
        <label class="form-label fw-semibold text-danger">{{ form.fournisseur.label }}</label>
        {{ form.fournisseur }}
        
      </div>

      <button type="submit" class="btn btn-danger mt-4">Valider lâ€™approvisionnement</button>
    </form>

    <!-- Historique -->
    <div class="mt-5">
      <h4 class="mb-3 text-danger">ðŸ“œ Historique des approvisionnements</h4>
      <input type="text" id="recherche" class="form-control mb-3" placeholder="ðŸ”Ž Rechercher un produit...">

      <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover">
          <thead class="table-dark text-center">
            <tr>
              <th>Produit</th>
              <th>QuantitÃ©</th>
              <th>Prix Unitaire</th>
              <th>Date</th>
              <th>Fournisseur</th>
            </tr>
          </thead>
          <tbody id="historique">
            {% for appro in historique %}
              <tr>
                <td>{{ appro.id_produit.nom_produit }}</td>
                <td>{{ appro.quantite }}</td>
                <td>{{ appro.prix_unitaire }} CFA</td>
                <td>{{ appro.id_appro.date|date:"d/m/Y H:i" }}</td>
                <td>{{ appro.id_appro.id_frs.nom_frs }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    document.getElementById("barcodeInput").addEventListener("change", function () {
      let code = this.value.trim();
      if (code) {
        fetch(`/stock/api/produit/${code}/`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              document.getElementById("produit-info").classList.remove("d-none");
              document.getElementById("produit-nom").innerText = data.nom;
              document.getElementById("produit-ref").innerText = data.reference;
              document.getElementById("produit-stock").innerText = data.stock;
             // document.getElementById("produit-id").value = data.id_produit;
              document.getElementById("form-produit-id").value = data.id_produit;
              document.getElementById("produit-image").src = data.image_url;
            } else {
              alert("Produit non trouvÃ© !");
            }
          });
      }
      this.value = ''; // reset input
    });
  </script>

</body>
</html>
 <i class="bi bi-upc-scan" style="font-size: 3rem;"></i>